generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                        String              @id @default(cuid())
  username                  String              @unique
  email                     String?             @unique
  password                  String
  name                      String
  active                    Boolean             @default(true)
  isSuperAdmin              Boolean             @default(false)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt
  createdById               String?
  updatedById               String?
  accounts                  Account[]
  activities                Activity[]          @relation("ActivityCreatedBy")
  cashMovements             CashMovement[]
  cashShifts                CashShift[]
  invoicesCreated           Invoice[]           @relation("InvoiceCreatedBy")
  invoicesUpdated           Invoice[]           @relation("InvoiceUpdatedBy")
  createdJournalEntries     JournalEntry[]      @relation("CreatedJournalEntries")
  assignedLeads             Lead[]              @relation("LeadAssignedTo")
  createdLeads              Lead[]              @relation("LeadCreatedBy")
  leadStageHistory          LeadStageHistory[]  @relation("LeadStageHistoryChangedBy")
  marketingCampaignsCreated MarketingCampaign[] @relation("MarketingCampaignCreatedBy")
  paymentsCreated           Payment[]           @relation("PaymentCreatedBy")
  physicalInventories       PhysicalInventory[] @relation("PhysicalInventoryCreatedBy")
  returnsCreated            Return[]            @relation("ReturnCreatedBy")
  returnPaymentsCreated     ReturnPayment[]     @relation("ReturnPaymentCreatedBy")
  sessions                  Session[]
  stockMovements            StockMovement[]
  createdBy                 User?               @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers              User[]              @relation("UserCreatedBy")
  updatedBy                 User?               @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  updatedUsers              User[]              @relation("UserUpdatedBy")
  userRoles                 UserRole[]
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  rolePermissions RolePermission[]
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

model Product {
  id                      String                  @id @default(cuid())
  sku                     String                  @unique
  barcode                 String?                 @unique
  name                    String
  brand                   String?
  category                String?
  unitOfMeasure           String                  @default("UNIT")
  cost                    Float                   @default(0)
  price                   Float
  taxRate                 Float                   @default(0)
  trackStock              Boolean                 @default(true)
  active                  Boolean                 @default(true)
  description             String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  createdById             String?
  updatedById             String?
  productType             String                  @default("RETAIL")
  enableRecipeConsumption Boolean                 @default(false)
  printerStation          String?
  preferredZoneId         String?
  goodsReceiptItems       GoodsReceiptItem[]
  invoiceItems            InvoiceItem[]
  physicalInventoryItems  PhysicalInventoryItem[]
  priceListItems          PriceListItem[]
  variants                ProductVariant[]
  purchaseOrderItems      PurchaseOrderItem[]
  quotationItems          QuotationItem[]
  recipe                  Recipe?
  recipeItems             RecipeItem[]            @relation("Ingredient")
  salesOrderItems         SalesOrderItem[]
  stockLevels             StockLevel[]
  stockMovements          StockMovement[]
}

model ProductVariant {
  id                     String                  @id @default(cuid())
  productId              String
  name                   String
  sku                    String?                 @unique
  barcode                String?                 @unique
  cost                   Float?
  price                  Float?
  active                 Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  goodsReceiptItems      GoodsReceiptItem[]
  invoiceItems           InvoiceItem[]
  physicalInventoryItems PhysicalInventoryItem[]
  product                Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  purchaseOrderItems     PurchaseOrderItem[]
  quotationItems         QuotationItem[]
  salesOrderItems        SalesOrderItem[]
  stockLevels            StockLevel[]
  stockMovements         StockMovement[]
}

model Warehouse {
  id                  String              @id @default(cuid())
  name                String              @unique
  address             String?
  active              Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  goodsReceipts       GoodsReceipt[]
  physicalInventories PhysicalInventory[]
  stockLevels         StockLevel[]
  stockMovements      StockMovement[]
}

model WarehouseZone {
  id          String   @id @default(cuid())
  name        String
  description String?
  warehouseId String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StockLevel {
  id          String          @id @default(cuid())
  warehouseId String
  productId   String?
  variantId   String?
  quantity    Float           @default(0)
  minStock    Float           @default(0)
  maxStock    Float           @default(0)
  updatedAt   DateTime        @updatedAt
  zoneId      String?
  product     Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse   Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([warehouseId])
  @@index([productId])
}

model StockMovement {
  id          String          @id @default(cuid())
  warehouseId String
  productId   String?
  variantId   String?
  type        String
  quantity    Float
  cost        Float?
  reference   String?
  reason      String?
  createdAt   DateTime        @default(now())
  createdById String
  reasonCode  String?
  reasonNote  String?
  zoneId      String?
  createdBy   User            @relation(fields: [createdById], references: [id])
  product     Product?        @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  warehouse   Warehouse       @relation(fields: [warehouseId], references: [id])

  @@index([warehouseId, productId])
  @@index([createdAt])
  @@index([type])
}

model PhysicalInventory {
  id           String                  @id @default(cuid())
  number       String                  @unique
  warehouseId  String
  status       String                  @default("PENDING")
  startedAt    DateTime?
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  createdById  String
  approvedAt   DateTime?
  approvedById String?
  createdBy    User                    @relation("PhysicalInventoryCreatedBy", fields: [createdById], references: [id])
  warehouse    Warehouse               @relation(fields: [warehouseId], references: [id])
  items        PhysicalInventoryItem[]

  @@index([warehouseId])
  @@index([status])
  @@index([createdAt])
}

model PhysicalInventoryItem {
  id                  String            @id @default(cuid())
  physicalInventoryId String
  productId           String?
  variantId           String?
  systemQuantity      Float
  countedQuantity     Float?
  difference          Float?
  notes               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  zoneId              String?
  physicalInventory   PhysicalInventory @relation(fields: [physicalInventoryId], references: [id], onDelete: Cascade)
  product             Product?          @relation(fields: [productId], references: [id])
  variant             ProductVariant?   @relation(fields: [variantId], references: [id])

  @@index([physicalInventoryId])
  @@index([productId])
}

model Customer {
  id                 String                       @id @default(cuid())
  name               String
  phone              String?
  email              String?
  address            String?
  taxId              String?
  tags               String?
  notes              String?
  active             Boolean                      @default(true)
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  createdById        String?
  updatedById        String?
  creditLimit        Float                        @default(0)
  currentBalance     Float                        @default(0)
  isCompany          Boolean                      @default(false)
  taxRegime          String?
  idType             String?
  activities         Activity[]
  invoices           Invoice[]
  leads              Lead[]
  campaignRecipients MarketingCampaignRecipient[]
  priceListItems     PriceListItem[]
  quotations         Quotation[]
  salesOrders        SalesOrder[]
}

model Lead {
  id                String             @id @default(cuid())
  customerId        String?
  name              String
  phone             String?
  email             String?
  company           String?
  stage             String             @default("NEW")
  value             Float?
  expectedRevenue   Float?
  probability       Float?             @default(0)
  expectedCloseDate DateTime?
  assignedToId      String?
  source            String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  createdById       String?
  updatedById       String?
  instagram         String?
  activities        Activity[]
  chatMessages      ChatMessage[]
  assignedTo        User?              @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  createdBy         User?              @relation("LeadCreatedBy", fields: [createdById], references: [id])
  customer          Customer?          @relation(fields: [customerId], references: [id])
  stageHistory      LeadStageHistory[]
  quotations        Quotation[]
}

model LeadStageHistory {
  id          String   @id @default(cuid())
  leadId      String
  fromStage   String?
  toStage     String
  changedById String?
  changedAt   DateTime @default(now())
  notes       String?
  changedBy   User?    @relation("LeadStageHistoryChangedBy", fields: [changedById], references: [id])
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

model Activity {
  id          String    @id @default(cuid())
  leadId      String?
  customerId  String?
  type        String
  subject     String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  createdBy   User?     @relation("ActivityCreatedBy", fields: [createdById], references: [id])
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model PriceListItem {
  id           String   @id @default(cuid())
  customerId   String
  productId    String
  specialPrice Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
}

model Quotation {
  id          String          @id @default(cuid())
  number      String          @unique
  customerId  String
  leadId      String?
  status      String          @default("DRAFT")
  subtotal    Float           @default(0)
  discount    Float           @default(0)
  tax         Float           @default(0)
  total       Float           @default(0)
  validUntil  DateTime?
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdById String?
  updatedById String?
  customer    Customer        @relation(fields: [customerId], references: [id])
  lead        Lead?           @relation(fields: [leadId], references: [id])
  items       QuotationItem[]
  salesOrders SalesOrder[]
}

model QuotationItem {
  id          String          @id @default(cuid())
  quotationId String
  productId   String
  variantId   String?
  quantity    Float
  unitPrice   Float
  discount    Float           @default(0)
  taxRate     Float
  subtotal    Float
  createdAt   DateTime        @default(now())
  product     Product         @relation(fields: [productId], references: [id])
  quotation   Quotation       @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
}

model SalesOrder {
  id          String           @id @default(cuid())
  number      String           @unique
  quotationId String?
  customerId  String
  status      String           @default("OPEN")
  subtotal    Float            @default(0)
  discount    Float            @default(0)
  tax         Float            @default(0)
  total       Float            @default(0)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdById String?
  updatedById String?
  invoices    Invoice[]
  customer    Customer         @relation(fields: [customerId], references: [id])
  quotation   Quotation?       @relation(fields: [quotationId], references: [id])
  items       SalesOrderItem[]
}

model SalesOrderItem {
  id           String          @id @default(cuid())
  salesOrderId String
  productId    String
  variantId    String?
  quantity     Float
  unitPrice    Float
  discount     Float           @default(0)
  taxRate      Float
  subtotal     Float
  createdAt    DateTime        @default(now())
  product      Product         @relation(fields: [productId], references: [id])
  salesOrder   SalesOrder      @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  variant      ProductVariant? @relation(fields: [variantId], references: [id])
}

model Invoice {
  id                 String        @id @default(cuid())
  number             String        @unique
  prefix             String?
  consecutive        String?
  salesOrderId       String?
  customerId         String
  status             String        @default("EMITIDA")
  subtotal           Float         @default(0)
  discount           Float         @default(0)
  tax                Float         @default(0)
  total              Float         @default(0)
  notes              String?
  issuedAt           DateTime?
  dueDate            DateTime?
  paidAt             DateTime?
  cufe               String?       @unique
  qrCode             String?
  electronicStatus   String?
  electronicSentAt   DateTime?
  electronicResponse String?
  resolutionNumber   String?
  alegraInvoiceId    String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  createdById        String?
  updatedById        String?
  balance            Float         @default(0)
  createdBy          User?         @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  customer           Customer      @relation(fields: [customerId], references: [id])
  salesOrder         SalesOrder?   @relation(fields: [salesOrderId], references: [id])
  updatedBy          User?         @relation("InvoiceUpdatedBy", fields: [updatedById], references: [id])
  items              InvoiceItem[]
  payments           Payment[]
  returns            Return[]
}

model InvoiceItem {
  id               String          @id @default(cuid())
  invoiceId        String
  productId        String
  variantId        String?
  quantity         Float
  unitPrice        Float
  discount         Float           @default(0)
  taxRate          Float           @default(0)
  subtotal         Float
  createdAt        DateTime        @default(now())
  preparationNotes String?
  invoice          Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product          Product         @relation(fields: [productId], references: [id])
  variant          ProductVariant? @relation(fields: [variantId], references: [id])
  returnItems      ReturnItem[]
}

model TaxRate {
  id          String   @id @default(cuid())
  name        String
  type        String
  rate        Float
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InvoiceLineTax {
  id            String  @id @default(cuid())
  invoiceItemId String
  taxRateId     String?
  baseAmount    Float
  taxAmount     Float
  rate          Float
  name          String

  @@index([invoiceItemId])
  @@index([taxRateId])
}

model InvoiceTaxSummary {
  id         String  @id @default(cuid())
  invoiceId  String
  taxRateId  String?
  name       String
  baseAmount Float
  taxAmount  Float
  rate       Float

  @@index([invoiceId])
  @@index([taxRateId])
}

model Payment {
  id                       String   @id @default(cuid())
  invoiceId                String
  amount                   Float
  method                   String
  reference                String?
  notes                    String?
  createdAt                DateTime @default(now())
  createdById              String?
  mercadoPagoPaymentId     String?
  mercadoPagoPreferenceId  String?
  mercadoPagoStatus        String?
  mercadoPagoStatusDetail  String?
  mercadoPagoPaymentMethod String?
  mercadoPagoTransactionId String?
  mercadoPagoResponse      String?
  updatedAt                DateTime @updatedAt
  paymentMethodId          String?
  createdBy                User?    @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  invoice                  Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Return {
  id          String          @id @default(cuid())
  invoiceId   String
  status      String          @default("COMPLETED")
  reason      String
  total       Float           @default(0)
  createdAt   DateTime        @default(now())
  createdById String?
  createdBy   User?           @relation("ReturnCreatedBy", fields: [createdById], references: [id])
  invoice     Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  items       ReturnItem[]
  payments    ReturnPayment[]

  @@index([invoiceId])
  @@index([createdAt])
}

model ReturnItem {
  id            String      @id @default(cuid())
  returnId      String
  invoiceItemId String
  quantity      Float
  total         Float       @default(0)
  createdAt     DateTime    @default(now())
  invoiceItem   InvoiceItem @relation(fields: [invoiceItemId], references: [id])
  return        Return      @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
  @@index([invoiceItemId])
}

model ReturnPayment {
  id          String   @id @default(cuid())
  returnId    String
  amount      Float
  method      String
  reference   String?
  notes       String?
  createdAt   DateTime @default(now())
  createdById String?
  createdBy   User?    @relation("ReturnPaymentCreatedBy", fields: [createdById], references: [id])
  return      Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
  @@index([createdAt])
}

model CreditNote {
  id                     String                  @id @default(cuid())
  number                 String                  @unique
  prefix                 String?
  consecutive            String?
  invoiceId              String
  returnId               String?                 @unique
  type                   String
  referenceCode          String
  affectedPeriod         String?
  subtotal               Float                   @default(0)
  discount               Float                   @default(0)
  tax                    Float                   @default(0)
  total                  Float                   @default(0)
  cufe                   String?                 @unique
  qrCode                 String?
  electronicStatus       String?
  electronicSentAt       DateTime?
  electronicResponse     String?
  resolutionNumber       String?
  reason                 String
  notes                  String?
  status                 String                  @default("PENDING")
  issuedAt               DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  createdById            String?
  alegraId               String?
  CreditNoteTransmission CreditNoteTransmission?

  @@index([invoiceId])
  @@index([status])
  @@index([createdAt])
  @@index([electronicStatus])
}

model CreditNoteItem {
  id            String   @id @default(cuid())
  creditNoteId  String
  invoiceItemId String?
  productId     String
  variantId     String?
  description   String
  quantity      Float
  unitPrice     Float
  discount      Float    @default(0)
  taxRate       Float    @default(0)
  subtotal      Float
  createdAt     DateTime @default(now())

  @@index([creditNoteId])
  @@index([invoiceItemId])
  @@index([productId])
}

model CreditNoteLineTax {
  id               String  @id @default(cuid())
  creditNoteItemId String
  taxRateId        String?
  baseAmount       Float
  taxAmount        Float
  rate             Float
  name             String

  @@index([creditNoteItemId])
  @@index([taxRateId])
}

model CreditNoteTaxSummary {
  id           String  @id @default(cuid())
  creditNoteId String
  taxRateId    String?
  name         String
  baseAmount   Float
  taxAmount    Float
  rate         Float

  @@index([creditNoteId])
  @@index([taxRateId])
}

model CreditNoteTransmission {
  id            String    @id @default(cuid())
  creditNoteId  String    @unique
  provider      String
  externalId    String?
  status        String    @default("PENDING")
  xmlGenerated  Boolean   @default(false)
  xmlContent    String?
  transmittedAt DateTime?
  responseData  String?
  errorMessage  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  creditNote CreditNote        @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  events     CreditNoteEvent[]

  @@index([creditNoteId])
  @@index([status])
}

model CreditNoteEvent {
  id             String   @id @default(cuid())
  transmissionId String
  event          String
  message        String?
  data           String?
  createdAt      DateTime @default(now())

  transmission CreditNoteTransmission @relation(fields: [transmissionId], references: [id], onDelete: Cascade)

  @@index([transmissionId])
  @@index([event])
}

model Supplier {
  id             String          @id @default(cuid())
  name           String
  phone          String?
  email          String?
  address        String?
  taxId          String?
  notes          String?
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  createdById    String?
  updatedById    String?
  purchaseOrders PurchaseOrder[]
}

model MarketingCampaign {
  id          String                       @id @default(cuid())
  name        String
  subject     String
  htmlContent String
  status      String                       @default("DRAFT")
  scheduledAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime                     @default(now())
  updatedAt   DateTime                     @updatedAt
  createdById String?
  createdBy   User?                        @relation("MarketingCampaignCreatedBy", fields: [createdById], references: [id])
  recipients  MarketingCampaignRecipient[]
}

model MarketingCampaignRecipient {
  id         String            @id @default(cuid())
  campaignId String
  customerId String?
  email      String
  status     String            @default("PENDING")
  sentAt     DateTime?
  error      String?
  createdAt  DateTime          @default(now())
  retryCount Int               @default(0)
  campaign   MarketingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  customer   Customer?         @relation(fields: [customerId], references: [id])

  @@index([campaignId])
  @@index([customerId])
  @@index([email])
}

model Unsubscribe {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

model PurchaseOrder {
  id            String              @id @default(cuid())
  number        String              @unique
  supplierId    String
  status        String              @default("DRAFT")
  subtotal      Float               @default(0)
  discount      Float               @default(0)
  tax           Float               @default(0)
  total         Float               @default(0)
  expectedDate  DateTime?
  notes         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdById   String?
  updatedById   String?
  goodsReceipts GoodsReceipt[]
  supplier      Supplier            @relation(fields: [supplierId], references: [id])
  items         PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String          @id @default(cuid())
  purchaseOrderId String
  productId       String
  variantId       String?
  quantity        Float
  unitCost        Float
  taxRate         Float
  subtotal        Float
  createdAt       DateTime        @default(now())
  product         Product         @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
}

model GoodsReceipt {
  id              String             @id @default(cuid())
  number          String             @unique
  purchaseOrderId String
  warehouseId     String
  receivedAt      DateTime           @default(now())
  notes           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  createdById     String?
  updatedById     String?
  purchaseOrder   PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id])
  warehouse       Warehouse          @relation(fields: [warehouseId], references: [id])
  items           GoodsReceiptItem[]
}

model GoodsReceiptItem {
  id                  String          @id @default(cuid())
  goodsReceiptId      String
  purchaseOrderItemId String?
  productId           String
  variantId           String?
  quantity            Float
  unitCost            Float
  createdAt           DateTime        @default(now())
  goodsReceipt        GoodsReceipt    @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  product             Product         @relation(fields: [productId], references: [id])
  variant             ProductVariant? @relation(fields: [variantId], references: [id])
}

model CashShift {
  id           String         @id @default(cuid())
  userId       String
  openedAt     DateTime       @default(now())
  closedAt     DateTime?
  startingCash Float          @default(0)
  expectedCash Float          @default(0)
  countedCash  Float?
  difference   Float?
  status       String         @default("OPEN")
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  movements    CashMovement[]
  user         User           @relation(fields: [userId], references: [id])
}

model CashMovement {
  id          String    @id @default(cuid())
  cashShiftId String
  type        String
  amount      Float
  reason      String?
  createdAt   DateTime  @default(now())
  createdById String
  cashShift   CashShift @relation(fields: [cashShiftId], references: [id], onDelete: Cascade)
  createdBy   User      @relation(fields: [createdById], references: [id])
}

model PaymentMethod {
  id        String   @id @default(cuid())
  name      String   @unique
  type      String   @default("ELECTRONIC")
  active    Boolean  @default(true)
  config    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  color     String?
  icon      String?
}

model ShiftSummary {
  id              String @id @default(cuid())
  shiftId         String
  paymentMethodId String
  expectedAmount  Float  @default(0)
  actualAmount    Float?

  @@unique([shiftId, paymentMethodId])
}

model Tenant {
  id            String          @id @default(cuid())
  name          String
  slug          String          @unique
  email         String?
  phone         String?
  address       String?
  databaseUrl   String          @unique
  active        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  subscriptions Subscription?
  settings      TenantSettings?
}

model Plan {
  id            String         @id @default(cuid())
  name          String         @unique
  description   String?
  price         Float
  currency      String         @default("COP")
  interval      String
  features      String?
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
}

model Subscription {
  id                       String    @id @default(cuid())
  tenantId                 String    @unique
  planId                   String
  status                   String
  startDate                DateTime
  endDate                  DateTime?
  trialEndDate             DateTime?
  autoRenew                Boolean   @default(true)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  mercadoPagoPaymentId     String?
  mercadoPagoPreferenceId  String?
  mercadoPagoStatus        String?
  mercadoPagoStatusDetail  String?
  mercadoPagoPaymentMethod String?
  mercadoPagoTransactionId String?
  mercadoPagoResponse      String?
  plan                     Plan      @relation(fields: [planId], references: [id])
  tenant                   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantSettings {
  id                          String    @id @default(cuid())
  tenantId                    String    @unique
  electronicBillingProvider   String?
  electronicBillingApiUrl     String?
  electronicBillingApiKey     String?
  companyNit                  String?
  companyName                 String?
  companyAddress              String?
  companyPhone                String?
  companyEmail                String?
  billingResolutionNumber     String?
  billingResolutionPrefix     String?
  billingResolutionFrom       String?
  billingResolutionTo         String?
  billingResolutionValidFrom  DateTime?
  billingResolutionValidTo    DateTime?
  subscriptionTrialDays       Int?      @default(14)
  subscriptionGracePeriodDays Int?      @default(7)
  subscriptionAutoRenew       Boolean?  @default(true)
  timezone                    String?   @default("America/Bogota")
  currency                    String?   @default("COP")
  dateFormat                  String?   @default("DD/MM/YYYY")
  timeFormat                  String?   @default("24h")
  language                    String?   @default("es")
  invoicePrefix               String?   @default("FV")
  invoiceNumberFormat         String?   @default("000000")
  quotationPrefix             String?   @default("COT")
  quotationNumberFormat       String?   @default("000000")
  purchaseOrderPrefix         String?   @default("OC")
  purchaseOrderNumberFormat   String?   @default("000000")
  customSettings              String?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  onboardingCompleted         Boolean?  @default(false)
  onboardingUserName          String?
  onboardingCompanyName       String?
  mercadoPagoAccessToken      String?
  mercadoPagoPublicKey        String?
  mercadoPagoEnabled          Boolean?  @default(false)
  mercadoPagoWebhookUrl       String?
  metaBusinessId              String?
  metaAccessToken             String?
  whatsappPhoneNumberId       String?
  instagramAccountId          String?
  enableRestaurantMode        Boolean?  @default(false)
  alegraEmail                 String?
  alegraToken                 String?
  softwareId                  String?
  softwarePin                 String?
  technicalKey                String?
  tenant                      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model ChatMessage {
  id         String   @id @default(cuid())
  leadId     String
  direction  String
  channel    String
  type       String   @default("text")
  content    String
  mediaUrl   String?
  externalId String?  @unique
  status     String   @default("SENT")
  createdAt  DateTime @default(now())
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([externalId])
}

model ElectronicInvoiceProviderConfig {
  id                   String    @id @default(cuid())
  tenantId             String
  provider             String    @default("ALEGRA")
  alegraEmail          String
  alegraTokenEncrypted String
  status               String    @default("disconnected")
  lastCheckedAt        DateTime?
  companyInfo          Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@unique([tenantId, provider])
}

model ElectronicInvoiceTransmission {
  id               String    @id @default(cuid())
  tenantId         String
  invoiceId        String
  provider         String    @default("ALEGRA")
  status           String    @default("QUEUED")
  attemptCount     Int       @default(0)
  lastAttemptAt    DateTime?
  alegraInvoiceId  String?
  lastErrorMessage String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([tenantId, invoiceId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

model ElectronicInvoiceEvent {
  id               String   @id @default(cuid())
  tenantId         String
  transmissionId   String
  eventType        String
  payloadSanitized Json?
  createdAt        DateTime @default(now())

  @@index([transmissionId, createdAt])
}

model Unit {
  id              String           @id @default(cuid())
  name            String
  symbol          String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  recipeItems     RecipeItem[]
  conversionsFrom UnitConversion[] @relation("FromUnit")
  conversionsTo   UnitConversion[] @relation("ToUnit")
}

model UnitConversion {
  id         String   @id @default(cuid())
  fromUnitId String
  toUnitId   String
  multiplier Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  fromUnit   Unit     @relation("FromUnit", fields: [fromUnitId], references: [id], onDelete: Cascade)
  toUnit     Unit     @relation("ToUnit", fields: [toUnitId], references: [id], onDelete: Cascade)
}

model Recipe {
  id        String       @id @default(cuid())
  productId String       @unique
  yield     Float        @default(1)
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  items     RecipeItem[]
}

model RecipeItem {
  id           String   @id @default(cuid())
  recipeId     String
  ingredientId String
  quantity     Float
  unitId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ingredient   Product  @relation("Ingredient", fields: [ingredientId], references: [id])
  recipe       Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  unit         Unit?    @relation(fields: [unitId], references: [id])

  @@index([recipeId])
  @@index([ingredientId])
  @@index([recipeId], map: "ri_ rid_idx")
  @@index([recipeId], map: "ri_recipe_idx")
}

model Campaign {
  id          String    @id @default(cuid())
  name        String
  type        String
  status      String    @default("DRAFT")
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  spent       Float?    @default(0)
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
}

model Opportunity {
  id                String    @id @default(cuid())
  customerId        String
  campaignId        String?
  title             String
  value             Float
  stage             String    @default("LEAD")
  probability       Int       @default(0)
  expectedCloseDate DateTime?
  closedDate        DateTime?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdById       String?
  assignedToId      String?

  @@index([customerId])
  @@index([campaignId])
  @@index([stage])
  @@index([assignedToId])
}

model Quote {
  id            String    @id @default(cuid())
  quoteNumber   String    @unique
  customerId    String
  opportunityId String?
  status        String    @default("DRAFT")
  validUntil    DateTime?
  subtotal      Float     @default(0)
  discount      Float     @default(0)
  tax           Float     @default(0)
  total         Float     @default(0)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String?

  @@index([customerId])
  @@index([opportunityId])
  @@index([status])
}

model QuoteItem {
  id          String  @id @default(cuid())
  quoteId     String
  productId   String?
  description String
  quantity    Float
  unitPrice   Float
  discount    Float   @default(0)
  taxRate     Float   @default(0)
  subtotal    Float

  @@index([quoteId])
  @@index([productId])
}

model Employee {
  id           String        @id @default(cuid())
  userId       String?       @unique
  firstName    String
  lastName     String
  documentId   String        @unique
  email        String?
  phone        String?
  address      String?
  hireDate     DateTime
  baseSalary   Float
  status       String        @default("ACTIVE")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  payrollItems PayrollItem[]
}

model PayrollRun {
  id          String        @id @default(cuid())
  startDate   DateTime
  endDate     DateTime
  paymentDate DateTime?
  status      String        @default("DRAFT")
  total       Float         @default(0)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  items       PayrollItem[]
}

model PayrollItem {
  id           String     @id @default(cuid())
  payrollRunId String
  employeeId   String
  type         String
  description  String?
  amount       Float
  createdAt    DateTime   @default(now())
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  @@index([payrollRunId])
  @@index([employeeId])
}

model AccountingAccount {
  id           String             @id @default(cuid())
  code         String
  name         String
  type         String
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  description  String?
  level        Int                @default(1)
  parentId     String?
  tags         String[]           @default([])
  tenantId     String
  journalLines JournalEntryLine[]

  @@unique([tenantId, code])
  @@index([tenantId, type])
}

model JournalEntry {
  id           String             @id @default(cuid())
  date         DateTime
  description  String
  reference    String?
  status       String             @default("DRAFT")
  createdById  String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  approvedAt   DateTime?
  approvedById String?
  number       String
  period       String
  sourceDocId  String?
  sourceType   String?
  tenantId     String
  totalCredit  Float              @default(0)
  totalDebit   Float              @default(0)
  type         String
  updatedById  String?
  createdBy    User?              @relation("CreatedJournalEntries", fields: [createdById], references: [id])
  lines        JournalEntryLine[]

  @@unique([tenantId, number])
  @@index([tenantId, period])
  @@index([tenantId, date])
  @@index([tenantId, status])
}

model JournalEntryLine {
  id             String            @id @default(cuid())
  journalEntryId String
  accountId      String
  description    String?
  debit          Float             @default(0)
  credit         Float             @default(0)
  createdAt      DateTime          @default(now())
  customerId     String?
  supplierId     String?
  thirdPartyId   String?
  thirdPartyName String?
  thirdPartyNit  String?
  account        AccountingAccount @relation(fields: [accountId], references: [id])
  journalEntry   JournalEntry      @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@index([journalEntryId])
  @@index([accountId])
}

model AccountingPeriod {
  id         String    @id @default(cuid())
  tenantId   String
  year       Int
  month      Int
  isClosed   Boolean   @default(false)
  closedAt   DateTime?
  closedById String?

  @@unique([tenantId, year, month])
}

model AccountingAuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  entityType String
  entityId   String
  action     String
  userId     String
  changes    String?
  createdAt  DateTime @default(now())

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
}

model AccountingConfig {
  id                   String   @id @default(cuid())
  tenantId             String   @unique
  cashAccountId        String?
  bankAccountId        String?
  accountsReceivableId String?
  accountsPayableId    String?
  inventoryAccountId   String?
  salesRevenueId       String?
  vatGeneratedId       String?
  vatDeductibleId      String?
  costOfSalesId        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model ProductTaxes {
  A String
  B String

  @@unique([A, B], map: "_ProductTaxes_AB_unique")
  @@index([B], map: "_ProductTaxes_B_index")
  @@map("_ProductTaxes")
}
